<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive Star Map - A World Away</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/variables.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  </head>
  <body>
    <style>
      /* Page-specific styles only - variables loaded from external file */
      body {
        padding-top: 120px; /* Extra space for this page */
      }

      .starmap-container {
        position: relative;
        width: 100%;
        height: 600px;
        margin: 2rem 0;
        border-radius: var(--card-border-radius);
        overflow: hidden;
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
      }
    </style>

    <nav class="navbar">
      <div class="logoContainer">
        <div class="logoCircle">ðŸŒŒ</div>
        <div class="logoSlogan">Exora - Exploring Pathways Beyond</div>
      </div>
      <ul class="navLinks">
        <li><a href="https://exora-lovat.vercel.app/" class="nav-link">Home</a></li> 
        <li><a href="/starmap" class="nav-link active">Star Map</a></li>
        <li>
          <a href="/discovery-trends" class="nav-link">Discovery Trends</a>
        </li>
        <li><a href="/orbital-viewer" class="nav-link">Orbital Viewer</a></li>
        <li><a href="/planet-explorer" class="nav-link">Planet Explorer</a></li>
        <li>
          <a href="https://exora-lovat.vercel.app/radial-velocity" class="nav-link"
            >RV Analysis</a
          >
        </li>
      </ul>
    </nav>

    <main class="main-content">
      <div class="page-header">
        <h1>ðŸ”­ Interactive Star Map</h1>
        <p>
          Explore stars and discover their exoplanets. Click on stars with
          planets to learn more!
        </p>
      </div>

      <div class="controls-panel">
        <div class="control-group">
          <label for="distance-filter">Distance Filter (parsecs):</label>
          <input
            type="range"
            id="distance-filter"
            min="10"
            max="200"
            value="100"
            step="10"
          />
          <span id="distance-value">100</span>
        </div>
        <div class="control-group">
          <label for="star-type-filter">Star Type:</label>
          <select id="star-type-filter">
            <option value="all">All Types</option>
            <option value="G">G-type (Sun-like)</option>
            <option value="K">K-type (Orange dwarf)</option>
            <option value="M">M-type (Red dwarf)</option>
            <option value="F">F-type (Yellow-white)</option>
            <option value="A">A-type (White)</option>
          </select>
        </div>
        <div class="control-group">
          <button id="planets-only-btn" class="filter-btn">
            Show Only Stars with Planets
          </button>
          <button id="reset-view-btn" class="filter-btn">Reset View</button>
        </div>
      </div>

      <div class="starmap-container">
        <div id="starmap-canvas"></div>
        <div class="starmap-legend">
          <div class="legend-item">
            <div class="legend-color" style="background: #ffff88"></div>
            <span>Star with exoplanets</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ffffff"></div>
            <span>Star without known planets</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ff6666"></div>
            <span>Multiple planet systems</span>
          </div>
        </div>
      </div>

      <div class="star-info-panel" id="star-info-panel" style="display: none">
        <div class="panel-header">
          <h3 id="star-name">Star Information</h3>
          <button class="close-btn" onclick="closeStarInfo()">&times;</button>
        </div>
        <div class="panel-content">
          <div class="star-details">
            <p>
              <strong>Distance:</strong>
              <span id="star-distance">-</span> parsecs
            </p>
            <p><strong>Spectral Type:</strong> <span id="star-type">-</span></p>
            <p><strong>Temperature:</strong> <span id="star-temp">-</span> K</p>
            <p>
              <strong>Magnitude:</strong> <span id="star-magnitude">-</span>
            </p>
          </div>
          <div class="planets-list" id="planets-list">
            <h4>Discovered Exoplanets:</h4>
            <div id="planets-container"></div>
          </div>
        </div>
      </div>

      <div class="stats-overlay">
        <div class="stat-box">
          <span id="visible-stars-count">0</span>
          <label>Visible Stars</label>
        </div>
        <div class="stat-box">
          <span id="planet-stars-count">0</span>
          <label>Stars with Planets</label>
        </div>
      </div>
    </main>

    <script src="{{ url_for('static', filename='js/starmap.js') }}"></script>
    <script>
      let starsData = [];
      let scene,
        camera,
        renderer,
        stars = [];
      let selectedStar = null;
      let planetsOnlyMode = false;

      // Initialize the starmap
      document.addEventListener("DOMContentLoaded", function () {
        initStarMap();
        loadStarData();
        setupEventListeners();
      });

      function initStarMap() {
        const container = document.getElementById("starmap-canvas");
        const width = container.clientWidth;
        const height = 600;

        // Create scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000011);

        // Create camera
        camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
        camera.position.set(0, 0, 50);

        // Create renderer
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(width, height);
        container.appendChild(renderer.domElement);

        // Add controls
        setupControls();

        // Start animation loop
        animate();
      }

      function setupControls() {
        const canvas = renderer.domElement;
        let isMouseDown = false;
        let mouseX = 0,
          mouseY = 0;

        canvas.addEventListener("mousedown", (event) => {
          isMouseDown = true;
          mouseX = event.clientX;
          mouseY = event.clientY;
        });

        canvas.addEventListener("mouseup", () => {
          isMouseDown = false;
        });

        canvas.addEventListener("mousemove", (event) => {
          if (isMouseDown) {
            const deltaX = event.clientX - mouseX;
            const deltaY = event.clientY - mouseY;

            camera.position.x += deltaX * 0.1;
            camera.position.y -= deltaY * 0.1;

            mouseX = event.clientX;
            mouseY = event.clientY;
          }
        });

        canvas.addEventListener("wheel", (event) => {
          event.preventDefault();
          const delta = event.deltaY * 0.01;
          camera.position.z += delta;
          camera.position.z = Math.max(10, Math.min(200, camera.position.z));
        });

        // Click detection for star selection
        canvas.addEventListener("click", (event) => {
          const rect = canvas.getBoundingClientRect();
          const x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
          const y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

          const raycaster = new THREE.Raycaster();
          raycaster.setFromCamera({ x, y }, camera);

          const intersects = raycaster.intersectObjects(stars);
          if (intersects.length > 0) {
            const starObject = intersects[0].object;
            const starData = starObject.userData;
            showStarInfo(starData);
          }
        });
      }

      async function loadStarData() {
        try {
          const distanceLimit =
            document.getElementById("distance-filter").value;
          const response = await fetch(
            `/api/nearby-stars?distance=${distanceLimit}`
          );
          starsData = await response.json();

          renderStars();
          updateStats();
        } catch (error) {
          console.error("Error loading star data:", error);
        }
      }

      function renderStars() {
        // Clear existing stars
        stars.forEach((star) => scene.remove(star));
        stars = [];

        const starTypeFilter =
          document.getElementById("star-type-filter").value;

        starsData.forEach((star) => {
          // Apply filters
          if (starTypeFilter !== "all" && star.spectral_type !== starTypeFilter)
            return;
          if (planetsOnlyMode && !star.has_planets) return;

          // Convert celestial coordinates to 3D position
          const distance = star.distance;
          const ra = (star.ra * Math.PI) / 180;
          const dec = (star.dec * Math.PI) / 180;

          const x = distance * Math.cos(dec) * Math.cos(ra);
          const y = distance * Math.cos(dec) * Math.sin(ra);
          const z = distance * Math.sin(dec);

          // Create star geometry
          const geometry = new THREE.SphereGeometry(0.2, 8, 8);

          // Color based on properties
          let color = 0xffffff; // Default white
          if (star.has_planets) {
            color = star.planet_count > 1 ? 0xff6666 : 0xffff88;
          }

          const material = new THREE.MeshBasicMaterial({ color: color });
          const starMesh = new THREE.Mesh(geometry, material);

          starMesh.position.set(x, y, z);
          starMesh.userData = star;

          scene.add(starMesh);
          stars.push(starMesh);
        });
      }

      function animate() {
        requestAnimationFrame(animate);

        // Gentle rotation of the star field
        scene.rotation.y += 0.001;

        renderer.render(scene, camera);
      }

      function setupEventListeners() {
        document
          .getElementById("distance-filter")
          .addEventListener("input", function () {
            document.getElementById("distance-value").textContent = this.value;
            loadStarData();
          });

        document
          .getElementById("star-type-filter")
          .addEventListener("change", function () {
            renderStars();
            updateStats();
          });

        document
          .getElementById("planets-only-btn")
          .addEventListener("click", function () {
            planetsOnlyMode = !planetsOnlyMode;
            this.textContent = planetsOnlyMode
              ? "Show All Stars"
              : "Show Only Stars with Planets";
            this.classList.toggle("active");
            renderStars();
            updateStats();
          });

        document
          .getElementById("reset-view-btn")
          .addEventListener("click", function () {
            camera.position.set(0, 0, 50);
            scene.rotation.set(0, 0, 0);
          });
      }

      async function showStarInfo(starData) {
        selectedStar = starData;

        // Update star info panel
        document.getElementById("star-name").textContent = starData.name;
        document.getElementById("star-distance").textContent =
          starData.distance.toFixed(2);
        document.getElementById("star-type").textContent =
          starData.spectral_type;
        document.getElementById("star-temp").textContent = starData.temperature;
        document.getElementById("star-magnitude").textContent =
          starData.magnitude.toFixed(2);

        // Load planet information
        if (starData.has_planets) {
          try {
            const response = await fetch(
              `/api/star/${encodeURIComponent(starData.name)}`
            );
            const starInfo = await response.json();

            const planetsContainer =
              document.getElementById("planets-container");
            planetsContainer.innerHTML = "";

            if (starInfo.planets && starInfo.planets.length > 0) {
              starInfo.planets.forEach((planet) => {
                const planetElement = document.createElement("div");
                planetElement.className = "planet-item";
                planetElement.innerHTML = `
                                <h5>${planet.name}</h5>
                                <p>Discovery Year: ${
                                  planet.discovery_year || "Unknown"
                                }</p>
                                <p>Method: ${
                                  planet.discovery_method || "Unknown"
                                }</p>
                                ${
                                  planet.radius
                                    ? `<p>Radius: ${planet.radius.toFixed(
                                        2
                                      )} Earth radii</p>`
                                    : ""
                                }
                                ${
                                  planet.orbital_period
                                    ? `<p>Orbital Period: ${planet.orbital_period.toFixed(
                                        1
                                      )} days</p>`
                                    : ""
                                }
                            `;
                planetsContainer.appendChild(planetElement);
              });
            } else {
              planetsContainer.innerHTML =
                "<p>No detailed planet data available</p>";
            }
          } catch (error) {
            console.error("Error loading planet data:", error);
            document.getElementById("planets-container").innerHTML =
              "<p>Error loading planet data</p>";
          }
        } else {
          document.getElementById("planets-container").innerHTML =
            "<p>No known exoplanets for this star</p>";
        }

        document.getElementById("star-info-panel").style.display = "block";
      }

      function closeStarInfo() {
        document.getElementById("star-info-panel").style.display = "none";
        selectedStar = null;
      }

      function updateStats() {
        const visibleStars = stars.length;
        const planetsStars = stars.filter(
          (star) => star.userData.has_planets
        ).length;

        document.getElementById("visible-stars-count").textContent =
          visibleStars;
        document.getElementById("planet-stars-count").textContent =
          planetsStars;
      }
    </script>
  </body>
</html>
